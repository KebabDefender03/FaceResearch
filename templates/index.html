<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Model Research Lab</title>
    <style>
        /* --- THEME COLORS --- */
        :root {
            --bg-body: #121212;
            --bg-sidebar: #181818;
            --bg-card: #1e1e1e;
            --bg-input: #252526;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333;
            --accent-blue: #3a86ff;
            --accent-green: #27ae60;
            --accent-orange: #e67e22;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; background-color: var(--bg-body); color: var(--text-main); position: relative; }
        
        /* --- SIDEBARS --- */
        .sidebar { width: 280px; background-color: var(--bg-sidebar); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; }
        .sidebar-left { border-right: 1px solid var(--border-color); }
        .sidebar-right { border-left: 1px solid var(--border-color); width: 300px; font-size: 0.9em; line-height: 1.6; }
        .sidebar h2 { font-size: 1.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-top: 0; color: white; }

        /* --- TABS Styling --- */
        .tabs-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .tab-btn {
            background: transparent; border: 2px solid var(--border-color); color: var(--text-muted); padding: 10px 30px; border-radius: 30px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: 0.3s;
        }
        .tab-btn:hover { border-color: var(--text-main); color: var(--text-main); }
        .tab-btn.active-facenet { background: var(--accent-orange); border-color: var(--accent-orange); color: white; box-shadow: 0 0 15px rgba(230, 126, 34, 0.4); }
        .tab-btn.active-arcface { background: var(--accent-blue); border-color: var(--accent-blue); color: white; box-shadow: 0 0 15px rgba(58, 134, 255, 0.4); }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        .container { background: var(--bg-card); padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 100%; max-width: 800px; border: 1px solid var(--border-color); }
        
        h1 { margin-top: 0; color: white; text-align: center; letter-spacing: 1px; }

/* --- Inputs & Buttons --- */
        .upload-area { display: flex; justify-content: space-between; gap: 20px; margin: 30px 0; }
        .input-group { width: 48%; background: var(--bg-input); padding: 20px; border-radius: 10px; border: 2px dashed #444; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .input-group:hover { border-color: var(--accent-blue); background: rgba(58, 134, 255, 0.05); }
        .input-group.dragover { border-color: var(--accent-green); background: rgba(39, 174, 96, 0.1); }
        label { display: block; margin-bottom: 10px; font-weight: bold; pointer-events: none; }
        input[type="file"] { display: none; }
        .upload-placeholder { color: #888; font-size: 0.9em; padding: 20px 0; pointer-events: none; }
        .upload-placeholder .icon { font-size: 2em; margin-bottom: 10px; }
        .file-name { color: var(--accent-green); font-weight: bold; margin-top: 10px; word-break: break-all; }
        .preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-top: 15px; display: none; border: 1px solid #444; }

        /* Actie Knop Basis Stijl */
        button.action-btn { 
            background-color: #444; 
            color: white; 
            border: none; 
            padding: 15px 50px; 
            font-size: 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; /* Zorgt voor de soepele overgang */
            width: 100%; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- HOVER EFFECTEN (NIEUW) --- */
        
        /* 1. FaceNet (Oranje) Hover */
        .btn-facenet { background-color: var(--accent-orange) !important; }
        .btn-facenet:hover { 
            background-color: #d35400 !important; /* Donkerder Oranje */
            transform: translateY(-2px); /* Komt iets omhoog */
            box-shadow: 0 6px 12px rgba(230, 126, 34, 0.4); /* Grotere schaduw */
        }

        /* 2. ArcFace (Blauw) Hover */
        .btn-arcface { background-color: var(--accent-blue) !important; }
        .btn-arcface:hover { 
            background-color: #2563eb !important; /* Donkerder Blauw */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(58, 134, 255, 0.4);
        }

        /* 3. Export Knop (Groen) Hover - in Sidebar */
        .export-btn:hover { 
            background-color: #219150 !important; /* Donkerder Groen */
        }

        /* 4. Clear Knop (Rood) Hover - in Sidebar */
        .clear-btn:hover { 
            background-color: #c0392b !important; /* Donkerder Rood */
        }

        /* Tabs Hover */
        .tab-btn:hover { 
            border-color: var(--text-main); 
            color: var(--text-main); 
            background-color: rgba(255,255,255,0.05); /* Subtiel oplichten */
        }
        
        /* Actieve Tabs Hover (zodat ze fel blijven) */
        .tab-btn.active-facenet:hover { background-color: #d35400; border-color: #d35400; }
        .tab-btn.active-arcface:hover { background-color: #2563eb; border-color: #2563eb; }

        /* Results */
        #result-box { display: none; margin-top: 30px; padding: 25px; border-radius: 10px; text-align: center; }
        .match-box { background-color: rgba(0, 184, 148, 0.15); border: 2px solid #00b894; color: #55efc4; }
        .no-match-box { background-color: rgba(214, 48, 49, 0.15); border: 2px solid #ff7675; color: #ff7675; }

        /* Face Comparison Visualization */
        .face-comparison {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .face-box {
            text-align: center;
            position: relative;
            display: inline-block;
        }
        .face-box-inner {
            position: relative;
            width: 160px;
            height: 160px;
        }
        .face-box img {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid #444;
            display: block;
        }
        .face-box p {
            margin: 8px 0 0;
            font-size: 0.8em;
            color: #888;
        }
        .face-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 160px;
            height: 160px;
            pointer-events: none;
            border-radius: 7px;
        }
        .comparison-arrow {
            font-size: 2em;
            color: #666;
        }
        .comparison-arrow.match { color: #00b894; }
        .comparison-arrow.no-match { color: #ff7675; }
        
        .process-steps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .process-step {
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            color: #888;
        }
        .process-step.active {
            background: rgba(58, 134, 255, 0.2);
            color: var(--accent-blue);
        }

        /* Landmark Legend */
        .landmark-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0 5px;
            flex-wrap: wrap;
            font-size: 0.75em;
            color: #888;
        }
        .landmark-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .landmark-legend .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .landmark-legend .dot.eye { background: #00ff88; }
        .landmark-legend .dot.nose { background: #ff6b6b; }
        .landmark-legend .dot.mouth { background: #4ecdc4; }

        /* History & Info */
        .history-item { background: #2b2b2b; margin-bottom: 10px; padding: 12px; border-radius: 6px; font-size: 0.9em; border-left: 4px solid #555; }
        .history-names { font-weight: bold; color: white; }
        .history-meta { font-size: 0.8em; color: #888; display: flex; justify-content: space-between; margin-top: 5px; }
        
        .info-content { display: none; animation: fadeIn 0.5s; }
        .info-content.active { display: block; }
        .info-title { color: white; font-weight: bold; display: block; margin-bottom: 5px; font-size: 1.1em; }
        .info-text { color: var(--text-muted); margin-bottom: 20px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- LAB BUBBLES BACKGROUND --- */
        #background-bubbles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden; pointer-events: none;
        }

        .bubble {
            position: absolute; bottom: -100px; border-radius: 50%;
            opacity: 0.25; animation: floatUp linear forwards;
        }

        .bubble-orange { background: radial-gradient(circle at 30% 30%, #ffbd73, var(--accent-orange)); box-shadow: 0 0 20px var(--accent-orange); }
        .bubble-blue { background: radial-gradient(circle at 30% 30%, #73b1ff, var(--accent-blue)); box-shadow: 0 0 20px var(--accent-blue); }

        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.25; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        /* --- RESPONSIVE DESIGN --- */
        
        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
        }
        .menu-toggle-left { left: 15px; }
        .menu-toggle-right { right: 15px; }

        /* Sidebar overlay - hidden by default */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 99;
        }
        .sidebar-overlay.active { display: block; }

        /* Tablet (max-width: 1024px) */
        @media (max-width: 1024px) {
            .sidebar { width: 220px; padding: 15px; }
            .sidebar-right { width: 240px; }
            .main-content { padding: 30px 20px; }
            .container { padding: 30px; max-width: 600px; }
            h1 { font-size: 1.5em; }
            .tab-btn { padding: 8px 20px; font-size: 1em; }
        }

        /* Mobile (max-width: 768px) */
        @media (max-width: 768px) {
            body { 
                flex-direction: column; 
                height: auto; 
                overflow-y: auto; 
            }

            .menu-toggle { display: block; }

            .sidebar {
                position: fixed;
                top: 0;
                height: 100vh;
                width: 280px !important;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 100;
                padding-top: 20px;
            }
            .sidebar-left { left: 0; }
            .sidebar-right { 
                right: 0; 
                left: auto;
                transform: translateX(100%);
            }
            .sidebar.open { transform: translateX(0); }

            .main-content { 
                padding: 70px 15px 30px; 
                min-height: 100vh;
                width: 100%;
                box-sizing: border-box;
            }
            .container { 
                padding: 25px 20px; 
                border-radius: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            h1 { font-size: 1.3em; margin-bottom: 10px; }
            .container > p { font-size: 0.8em !important; margin-bottom: 20px !important; }

            .tabs-container { 
                flex-direction: row; 
                gap: 10px; 
                margin-bottom: 20px;
            }
            .tab-btn { 
                flex: 1;
                padding: 10px 8px; 
                font-size: 0.9em; 
            }

            .upload-area { 
                flex-direction: column; 
                gap: 15px; 
                margin: 20px 0;
            }
            .input-group { 
                width: 100%; 
                padding: 15px;
                box-sizing: border-box;
            }
            .preview-img { height: 180px; }
            .upload-placeholder { padding: 15px 0; }
            .upload-placeholder .icon { font-size: 1.8em; }

            button.action-btn { 
                padding: 14px 20px; 
                font-size: 16px;
                width: 100%;
            }

            #result-box { 
                padding: 20px; 
                margin-top: 20px;
            }
            #result-box h2 { font-size: 1.2em; }
            #similarity-pct { font-size: 1.1em !important; }
            
            /* Face comparison mobile */
            .face-comparison { gap: 15px; }
            .face-box img { width: 90px; height: 90px; }
            .face-box p { font-size: 0.7em; }
            .comparison-arrow { font-size: 1.5em; }
            .process-steps { gap: 5px; }
            .process-step { padding: 5px 8px; font-size: 0.65em; }
            
            /* Sidebar content adjustments */
            .sidebar h2 { font-size: 1em; padding-bottom: 12px; }
            .info-title { font-size: 0.95em; }
            .info-text { font-size: 0.85em; line-height: 1.5; margin-bottom: 15px; }
            .history-item { padding: 10px; font-size: 0.85em; }
        }

        /* Small Mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .menu-toggle { 
                padding: 8px 12px; 
                font-size: 1em;
                top: 10px;
            }
            .menu-toggle-left { left: 10px; }
            .menu-toggle-right { right: 10px; }
            
            .main-content { padding: 55px 10px 20px; }
            .container { padding: 15px; }
            h1 { font-size: 1.1em; }
            
            .tabs-container { gap: 8px; }
            .tab-btn { padding: 10px 5px; font-size: 0.85em; }
            
            .input-group { padding: 12px; }
            .upload-placeholder { padding: 12px 0; font-size: 0.85em; }
            .upload-placeholder .icon { font-size: 1.5em; }
            .preview-img { height: 140px; }
            
            button.action-btn { padding: 12px 15px; font-size: 14px; }
            
            #result-box { padding: 15px; }
            #result-box h2 { font-size: 1.1em; }
            #similarity-pct { font-size: 1em !important; }
            
            .sidebar { width: 260px !important; padding: 15px; }
            .info-title { font-size: 0.9em; }
            .info-text { font-size: 0.8em; }
        }

        /* Extra Small Mobile (max-width: 360px) */
        @media (max-width: 360px) {
            .main-content { padding: 50px 8px 15px; }
            .container { padding: 12px; }
            h1 { font-size: 1em; }
            .container > p { font-size: 0.75em !important; }
            
            .tab-btn { padding: 8px 4px; font-size: 0.8em; }
            
            .input-group { padding: 10px; }
            .preview-img { height: 120px; }
            label { font-size: 0.9em; }
            
            button.action-btn { padding: 10px; font-size: 13px; }
            
            #result-box p { font-size: 0.85em; }
        }
    </style>
</head>
<body>
    
    <div id="background-bubbles"></div>

    <!-- Mobile Menu Toggles -->
    <button class="menu-toggle menu-toggle-left" onclick="toggleSidebar('left')">üìú</button>
    <button class="menu-toggle menu-toggle-right" onclick="toggleSidebar('right')">üß†</button>
    <div class="sidebar-overlay" onclick="closeSidebars()"></div>

    <div class="sidebar sidebar-left" id="sidebar-left">
        <h2>üìú History</h2>
        <div id="history-list"></div>
        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
            <button onclick="exportToCSV()" style="background: var(--accent-green); color: white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">üì• Export to CSV</button>
            <button onclick="clearHistory()" style="background: #d63031; color: white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">üóëÔ∏è Clear History</button>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <h1>Face Research Lab</h1>
            <p style="color: #a0a0a0; font-style: italic; text-align: center; font-size: 0.9em; margin-bottom:30px;">
                Study: Impact of weight variance on biometric recognition accuracy
            </p>
            
            <div class="tabs-container">
                <button id="tab-facenet" class="tab-btn active-facenet" onclick="switchTab('facenet')">FaceNet512</button>
                <button id="tab-arcface" class="tab-btn" onclick="switchTab('arcface')">ArcFace</button>
            </div>

            <div class="upload-area">
                <div class="input-group" onclick="document.getElementById('file1').click()" ondragover="handleDragOver(event, this)" ondragleave="handleDragLeave(this)" ondrop="handleDrop(event, 'file1', 'preview1', this)">
                    <label>üì∑ Original Photo</label>
                    <input type="file" id="file1" accept="image/*" onchange="previewImage(this, 'preview1')">
                    <div class="upload-placeholder" id="placeholder1">
                        <div class="icon">üìÅ</div>
                        <div>Click or drag image here</div>
                    </div>
                    <div class="file-name" id="filename1"></div>
                    <img id="preview1" class="preview-img">
                </div>
                <div class="input-group" onclick="document.getElementById('file2').click()" ondragover="handleDragOver(event, this)" ondragleave="handleDragLeave(this)" ondrop="handleDrop(event, 'file2', 'preview2', this)">
                    <label>üì∑ Comparison Photo</label>
                    <input type="file" id="file2" accept="image/*" onchange="previewImage(this, 'preview2')">
                    <div class="upload-placeholder" id="placeholder2">
                        <div class="icon">üìÅ</div>
                        <div>Click or drag image here</div>
                    </div>
                    <div class="file-name" id="filename2"></div>
                    <img id="preview2" class="preview-img">
                </div>
            </div>

            <div style="text-align: center;">
                <button id="analyze-btn" class="action-btn btn-facenet" onclick="compareFaces()">Compare using FaceNet</button>
                <p id="loading" style="display:none; color: #aaa; margin-top: 15px;">Loading model...</p>
            </div>

            <div id="result-box">
                <h2 id="status-text" style="margin-top:0;"></h2>
                
                <!-- Face Comparison Visualization -->
                <div class="face-comparison" id="face-comparison">
                    <div class="face-box">
                        <div class="face-box-inner">
                            <img id="aligned-face1" src="" alt="Aligned Face 1">
                            <canvas id="face-canvas1" class="face-canvas" width="160" height="160"></canvas>
                        </div>
                        <p>Detected Face 1</p>
                    </div>
                    <div class="comparison-arrow" id="comparison-arrow">‚Üî</div>
                    <div class="face-box">
                        <div class="face-box-inner">
                            <img id="aligned-face2" src="" alt="Aligned Face 2">
                            <canvas id="face-canvas2" class="face-canvas" width="160" height="160"></canvas>
                        </div>
                        <p>Detected Face 2</p>
                    </div>
                </div>
                
                <!-- Landmark Legend -->
                <div class="landmark-legend">
                    <span><span class="dot eye"></span> Eyes</span>
                    <span><span class="dot nose"></span> Nose</span>
                    <span><span class="dot mouth"></span> Mouth</span>
                    <span style="color: #666;">Lines = Facial geometry</span>
                </div>
                
                <div class="process-steps">
                    <span class="process-step active">1. Detect</span>
                    <span class="process-step active">2. Align</span>
                    <span class="process-step active">3. Embed (512D)</span>
                    <span class="process-step active">4. Compare</span>
                </div>
                
                <p style="font-size: 1.4em; color: #fff; margin: 20px 0 10px;">Similarity: <strong id="similarity-pct" style="font-size: 1.2em;"></strong></p>
                <p style="color: #aaa; font-size: 0.9em;">Distance: <span id="score"></span> (Threshold: <span id="thresh"></span>)</p>
                <p style="font-size:0.85em; color:#666;">Model: <span id="res-model"></span></p>
            </div>
        </div>
    </div>

    <div class="sidebar sidebar-right" id="sidebar-right">
        <h2>üß† Methodology</h2>

        <div id="info-facenet" class="info-content active">
            <div class="info-title" style="color: var(--accent-orange);">Model: FaceNet512</div>
            <div class="info-text">Developed by Google Research in 2015. Creates a 512-dimensional embedding vector for each face using a deep CNN trained with triplet loss.</div>
            
            <div class="info-title">Technical Details</div>
            <div class="info-text">‚Ä¢ Architecture: Inception-ResNet-v1<br>‚Ä¢ Embedding Size: 512 dimensions<br>‚Ä¢ Distance Metric: Cosine distance<br>‚Ä¢ Training: Triplet loss function<br>‚Ä¢ Threshold: 0.30 (‚â•70% similarity = match)</div>
            
            <div class="info-title">Hypothesis: Weight Variance</div>
            <div class="info-text">FaceNet relies heavily on <strong>holistic facial geometry</strong> including jawline contours and cheek structure. Weight gain alters these soft tissue areas significantly, potentially causing <strong>false negatives</strong> (failing to recognize the same person).</div>
            
            <div class="info-title">Expected Behavior</div>
            <div class="info-text">May struggle with significant weight changes as the embedding captures overall face shape rather than immutable features.</div>
        </div>

        <div id="info-arcface" class="info-content">
            <div class="info-title" style="color: var(--accent-blue);">Model: ArcFace</div>
            <div class="info-text">State-of-the-art model developed by InsightFace (Imperial College London, 2019). Uses Additive Angular Margin Loss to learn highly discriminative face embeddings with better inter-class separation.</div>
            
            <div class="info-title">Technical Details</div>
            <div class="info-text">‚Ä¢ Architecture: ResNet-100 backbone<br>‚Ä¢ Embedding Size: 512 dimensions<br>‚Ä¢ Distance Metric: Cosine distance<br>‚Ä¢ Training: ArcFace loss (angular margin)<br>‚Ä¢ Threshold: 0.68 (‚â•32% similarity = match)</div>
            
            <div class="info-title">Hypothesis: Weight Variance</div>
            <div class="info-text">ArcFace focuses on <strong>angular relationships between facial landmarks</strong> (eyes, nose bridge, bone structure) rather than soft tissue. This makes it more robust to "soft tissue noise" like weight-related changes in cheeks and jawline.</div>
            
            <div class="info-title">Expected Behavior</div>
            <div class="info-text">Should maintain recognition accuracy despite weight changes, as core facial bone structure and eye geometry remain constant.</div>
        </div>
    </div>

<script>
    let currentModel = 'facenet';

    document.addEventListener("DOMContentLoaded", () => {
        loadHistory();
        for(let i=0; i<20; i++) { spawnInstantBubble(); }
        setInterval(createBubble, 800);
    });

    function spawnInstantBubble() { createBubble(true); }

    function createBubble(isInstant = false) {
        const bubbleContainer = document.getElementById('background-bubbles');
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        
        if (currentModel === 'facenet') {
            bubble.classList.add('bubble-orange');
        } else {
            bubble.classList.add('bubble-blue');
        }

        const size = Math.random() * 80 + 30;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.opacity = 0.25;
        bubble.style.left = `${Math.random() * 100}%`;
        
        const duration = Math.random() * 15 + 10;
        bubble.style.animationDuration = `${duration}s`;
        
        if (isInstant) {
            bubble.style.bottom = `${Math.random() * 100}%`; 
            bubble.style.animationDelay = "0s";
        } else {
            bubble.style.bottom = "-150px";
            bubble.style.animationDelay = `${Math.random() * 2}s`;
        }

        bubbleContainer.appendChild(bubble);
        setTimeout(() => { bubble.remove(); }, duration * 1000 + 3000);
    }

    function drawLandmarks(canvasId, landmarks, isMatch) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !landmarks) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Landmarks are already scaled to 160x160 by the backend
        const points = {
            leftEye: landmarks.left_eye ? { x: landmarks.left_eye.x, y: landmarks.left_eye.y } : null,
            rightEye: landmarks.right_eye ? { x: landmarks.right_eye.x, y: landmarks.right_eye.y } : null,
            nose: landmarks.nose ? { x: landmarks.nose.x, y: landmarks.nose.y } : null,
            mouthLeft: landmarks.mouth_left ? { x: landmarks.mouth_left.x, y: landmarks.mouth_left.y } : null,
            mouthRight: landmarks.mouth_right ? { x: landmarks.mouth_right.x, y: landmarks.mouth_right.y } : null
        };
        
        console.log('Drawing landmarks:', points);  // Debug
        
        // Line color based on match status
        const lineColor = isMatch ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 107, 107, 0.6)';
        
        // Draw connecting lines (facial geometry)
        ctx.strokeStyle = lineColor;
        ctx.lineWidth = 2;
        ctx.setLineDash([]);
        
        // Eye line
        if (points.leftEye && points.rightEye) {
            ctx.beginPath();
            ctx.moveTo(points.leftEye.x, points.leftEye.y);
            ctx.lineTo(points.rightEye.x, points.rightEye.y);
            ctx.stroke();
        }
        
        // Nose to eyes (triangle)
        if (points.nose) {
            if (points.leftEye) {
                ctx.beginPath();
                ctx.moveTo(points.leftEye.x, points.leftEye.y);
                ctx.lineTo(points.nose.x, points.nose.y);
                ctx.stroke();
            }
            if (points.rightEye) {
                ctx.beginPath();
                ctx.moveTo(points.rightEye.x, points.rightEye.y);
                ctx.lineTo(points.nose.x, points.nose.y);
                ctx.stroke();
            }
        }
        
        // Nose to mouth
        if (points.nose && points.mouthLeft && points.mouthRight) {
            const mouthCenter = {
                x: (points.mouthLeft.x + points.mouthRight.x) / 2,
                y: (points.mouthLeft.y + points.mouthRight.y) / 2
            };
            ctx.beginPath();
            ctx.moveTo(points.nose.x, points.nose.y);
            ctx.lineTo(mouthCenter.x, mouthCenter.y);
            ctx.stroke();
        }
        
        // Mouth line
        if (points.mouthLeft && points.mouthRight) {
            ctx.beginPath();
            ctx.moveTo(points.mouthLeft.x, points.mouthLeft.y);
            ctx.lineTo(points.mouthRight.x, points.mouthRight.y);
            ctx.stroke();
        }
        
        // Draw landmark points
        const dotSize = 5;
        
        // Eyes (green)
        ctx.fillStyle = '#00ff88';
        if (points.leftEye) {
            ctx.beginPath();
            ctx.arc(points.leftEye.x, points.leftEye.y, dotSize, 0, Math.PI * 2);
            ctx.fill();
        }
        if (points.rightEye) {
            ctx.beginPath();
            ctx.arc(points.rightEye.x, points.rightEye.y, dotSize, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Nose (red/coral)
        ctx.fillStyle = '#ff6b6b';
        if (points.nose) {
            ctx.beginPath();
            ctx.arc(points.nose.x, points.nose.y, dotSize, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Mouth corners (teal)
        ctx.fillStyle = '#4ecdc4';
        if (points.mouthLeft) {
            ctx.beginPath();
            ctx.arc(points.mouthLeft.x, points.mouthLeft.y, dotSize, 0, Math.PI * 2);
            ctx.fill();
        }
        if (points.mouthRight) {
            ctx.beginPath();
            ctx.arc(points.mouthRight.x, points.mouthRight.y, dotSize, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Add glow effect to points
        ctx.shadowBlur = 0;
    }

    function switchTab(model) {
        currentModel = model;
        
        document.getElementById('tab-facenet').className = model === 'facenet' ? 'tab-btn active-facenet' : 'tab-btn';
        document.getElementById('tab-arcface').className = model === 'arcface' ? 'tab-btn active-arcface' : 'tab-btn';
        
        const btn = document.getElementById('analyze-btn');
        btn.innerText = model === 'facenet' ? "Compare using FaceNet" : "Compare using ArcFace";
        btn.className = model === 'facenet' ? "action-btn btn-facenet" : "action-btn btn-arcface";

        document.getElementById('info-facenet').className = model === 'facenet' ? 'info-content active' : 'info-content';
        document.getElementById('info-arcface').className = model === 'arcface' ? 'info-content active' : 'info-content';

        const bubbles = document.querySelectorAll('.bubble');
        bubbles.forEach(b => {
            b.classList.remove('bubble-orange', 'bubble-blue');
            b.classList.add(model === 'facenet' ? 'bubble-orange' : 'bubble-blue');
        });
    }

    function previewImage(input, imgId) {
        const file = input.files[0];
        const fileNum = imgId === 'preview1' ? '1' : '2';
        if (file) {
            document.getElementById(imgId).src = URL.createObjectURL(file);
            document.getElementById(imgId).style.display = 'block';
            document.getElementById('placeholder' + fileNum).style.display = 'none';
            document.getElementById('filename' + fileNum).textContent = file.name;
        }
    }

    // Drag and drop handlers
    function handleDragOver(e, element) {
        e.preventDefault();
        e.stopPropagation();
        element.classList.add('dragover');
    }

    function handleDragLeave(element) {
        element.classList.remove('dragover');
    }

    function handleDrop(e, inputId, previewId, element) {
        e.preventDefault();
        e.stopPropagation();
        element.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            const input = document.getElementById(inputId);
            input.files = files;
            previewImage(input, previewId);
        }
    }

    async function compareFaces() {
        const file1 = document.getElementById('file1').files[0];
        const file2 = document.getElementById('file2').files[0];
        const loading = document.getElementById('loading');
        const resultBox = document.getElementById('result-box');

        if (!file1 || !file2) { alert("Please select both images!"); return; }

        resultBox.style.display = 'none';
        loading.style.display = 'block';
        loading.innerText = `Analyzing with ${currentModel === 'facenet' ? 'FaceNet512' : 'ArcFace'}...`;

        const formData = new FormData();
        formData.append('file1', file1);
        formData.append('file2', file2);
        formData.append('model', currentModel);

        try {
            const response = await fetch('/analyze', { method: 'POST', body: formData });
            const data = await response.json();

            loading.style.display = 'none';
            if (data.error) { alert("Error: " + data.error); return; }

            resultBox.style.display = 'block';
            const isMatch = data.verified;
            resultBox.className = isMatch ? "match-box" : "no-match-box";
            document.getElementById('status-text').innerText = isMatch ? "‚úÖ MATCH" : "‚ùå NO MATCH";
            
            // Display aligned faces if available
            const faceComparison = document.getElementById('face-comparison');
            const comparisonArrow = document.getElementById('comparison-arrow');
            
            if (data.face1 && data.face2) {
                document.getElementById('aligned-face1').src = data.face1.image;
                document.getElementById('aligned-face2').src = data.face2.image;
                faceComparison.style.display = 'flex';
                comparisonArrow.className = isMatch ? 'comparison-arrow match' : 'comparison-arrow no-match';
                comparisonArrow.innerHTML = isMatch ? '‚âà' : '‚â†';
                
                console.log('Face 1 landmarks:', data.face1.landmarks);
                console.log('Face 2 landmarks:', data.face2.landmarks);
                
                // Draw landmarks on face images after images load
                const drawAfterLoad = () => {
                    if (data.face1 && data.face1.landmarks) {
                        console.log('Drawing landmarks on face 1');
                        drawLandmarks('face-canvas1', data.face1.landmarks, isMatch);
                    }
                    if (data.face2 && data.face2.landmarks) {
                        console.log('Drawing landmarks on face 2');
                        drawLandmarks('face-canvas2', data.face2.landmarks, isMatch);
                    }
                };
                
                document.getElementById('aligned-face1').onload = drawAfterLoad;
                document.getElementById('aligned-face2').onload = drawAfterLoad;
                
                // Also draw after a delay in case images are cached
                setTimeout(drawAfterLoad, 200);
                setTimeout(drawAfterLoad, 500);
            } else {
                faceComparison.style.display = 'none';
            }
            
            // Calculate similarity percentage from cosine distance
            const similarityPct = ((1 - data.distance) * 100).toFixed(2);
            document.getElementById('similarity-pct').innerText = similarityPct + '%';
            
            document.getElementById('score').innerText = data.distance;
            document.getElementById('thresh').innerText = data.threshold;
            document.getElementById('res-model').innerText = data.model;

            addToHistory(data.model, data.filename1, data.filename2, data.verified, data.distance);

        } catch (error) {
            loading.style.display = 'none';
            alert("Something went wrong with the request.");
        }
    }

    function addToHistory(model, name1, name2, isMatch, distance) {
        let history = JSON.parse(localStorage.getItem('faceResearchHistory')) || [];
        history.unshift({
            model: model, name1: name1, name2: name2, isMatch: isMatch, distance: distance, time: new Date().toLocaleTimeString()
        });
        localStorage.setItem('faceResearchHistory', JSON.stringify(history));
        loadHistory();
    }

    function loadHistory() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('faceResearchHistory')) || [];
        list.innerHTML = ""; 
        if (history.length === 0) { list.innerHTML = "<p style='color: #666; font-style: italic;'>No tests yet...</p>"; return; }
        history.forEach(item => {
            const div = document.createElement('div');
            const statusColor = item.isMatch ? "#00b894" : "#ff7675";
            const icon = item.isMatch ? "‚úÖ" : "‚ùå";
            const modelColor = item.model.toLowerCase().includes('facenet') ? 'var(--accent-orange)' : 'var(--accent-blue)';
            div.className = "history-item";
            div.style.borderLeft = `4px solid ${statusColor}`;
            div.innerHTML = `
                <div class="history-names">${icon} ${item.name1} vs ${item.name2}</div>
                <div class="history-meta"><span style="color: ${modelColor}; font-weight:bold;">${item.model}</span><span>Dist: ${item.distance}</span></div>
            `;
            list.appendChild(div);
        });
    }

    function exportToCSV() {
        const history = JSON.parse(localStorage.getItem('faceResearchHistory'));
        if (!history || history.length === 0) { alert("No data available. Run some comparisons first!"); return; }
        
        // Properly escape CSV fields that might contain commas or quotes
        const escapeCSV = (field) => {
            if (field === null || field === undefined) return '';
            const str = String(field);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        };
        
        let csvContent = "Time,Model,File_Original,File_Comparison,Distance_Score,Result\n";
        history.forEach(item => {
            const resultText = item.isMatch ? "MATCH" : "NO MATCH";
            csvContent += `${escapeCSV(item.time)},${escapeCSV(item.model)},${escapeCSV(item.name1)},${escapeCSV(item.name2)},${escapeCSV(item.distance)},${escapeCSV(resultText)}\n`;
        });
        
        // Add BOM for Excel compatibility
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const timestamp = new Date().toISOString().slice(0,10);
        link.href = URL.createObjectURL(blob);
        link.download = `face_research_export_${timestamp}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href); // Clean up
    }
    
    function clearHistory() {
        if(confirm("Are you sure you want to clear the history?")) { localStorage.removeItem('faceResearchHistory'); loadHistory(); }
    }

    // Mobile sidebar toggle functions
    function toggleSidebar(side) {
        const leftSidebar = document.getElementById('sidebar-left');
        const rightSidebar = document.getElementById('sidebar-right');
        const overlay = document.querySelector('.sidebar-overlay');
        
        if (side === 'left') {
            const isOpen = leftSidebar.classList.contains('open');
            closeSidebars();
            if (!isOpen) {
                leftSidebar.classList.add('open');
                overlay.classList.add('active');
            }
        } else if (side === 'right') {
            const isOpen = rightSidebar.classList.contains('open');
            closeSidebars();
            if (!isOpen) {
                rightSidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
    }

    function closeSidebars() {
        document.getElementById('sidebar-left').classList.remove('open');
        document.getElementById('sidebar-right').classList.remove('open');
        document.querySelector('.sidebar-overlay').classList.remove('active');
    }

    // Close sidebars when clicking on main content on mobile
    document.querySelector('.main-content').addEventListener('click', function() {
        if (window.innerWidth <= 768) {
            closeSidebars();
        }
    });
</script>

</body>
</html>